# ğŸ—„ï¸ å•†å“æ¯”ä»·æ’ä»¶ - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“Œ è®¾è®¡æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°å•†å“æ¯”ä»·æ’ä»¶çš„æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ•°æ®æ¨¡å‹ã€è¡¨ç»“æ„ã€ç´¢å¼•è®¾è®¡ã€æ•°æ®æµç­‰è¯¦ç»†ä¿¡æ¯ã€‚

> **ğŸ’¡ MVPæç¤º**: å¦‚æœæ‚¨è¦å¿«é€Ÿå®ç°MVPç‰ˆæœ¬ï¼Œå¯ä»¥è·³è¿‡å¤æ‚çš„æ•°æ®åº“è®¾è®¡ï¼Œä½¿ç”¨ç®€åŒ–çš„æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆã€‚è¯¦è§ [MVPç®€åŒ–æ¶æ„æ–¹æ¡ˆ.md](./MVPç®€åŒ–æ¶æ„æ–¹æ¡ˆ.md)

## ğŸ¯ è®¾è®¡ç›®æ ‡

- æ”¯æŒé«˜å¹¶å‘æœç´¢è¯·æ±‚
- å­˜å‚¨ç”¨æˆ·è¡Œä¸ºæ•°æ®
- ç¼“å­˜çƒ­é—¨æœç´¢ç»“æœ
- ç»Ÿè®¡åˆ†æä¸šåŠ¡æ•°æ®
- ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§

## ğŸš€ ç‰ˆæœ¬é€‰æ‹©æŒ‡å—

### MVPç‰ˆæœ¬ (æ¨èå¿«é€Ÿå¯åŠ¨)
- âœ… **æ— éœ€æ•°æ®åº“**: ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ + å†…å­˜ç¼“å­˜
- âœ… **é›¶é…ç½®**: æ— éœ€å®‰è£…æ•°æ®åº“æœåŠ¡
- âœ… **å¿«é€Ÿå¼€å‘**: ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½å®ç°
- âš ï¸ **åŠŸèƒ½é™åˆ¶**: æ— ç”¨æˆ·ç³»ç»Ÿã€æ— å¤æ‚ç»Ÿè®¡

### ç”Ÿäº§ç‰ˆæœ¬ (å®Œæ•´åŠŸèƒ½)
- ğŸ”¥ **å®Œæ•´åŠŸèƒ½**: ç”¨æˆ·ç³»ç»Ÿã€æ•°æ®åˆ†æã€ç›‘æ§å‘Šè­¦
- ğŸ”¥ **é«˜æ€§èƒ½**: æ•°æ®åº“ä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥
- ğŸ”¥ **å¯æ‰©å±•**: æ”¯æŒå¤§è§„æ¨¡éƒ¨ç½²
- âš ï¸ **å¤æ‚åº¦é«˜**: éœ€è¦è¿ç»´å’Œæ•°æ®åº“ç®¡ç†ç»éªŒ

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®åº“é€‰å‹
- **ä¸»æ•°æ®åº“**: PostgreSQL 15+ (å…³ç³»å‹æ•°æ®ï¼Œäº‹åŠ¡æ”¯æŒ)
- **ç¼“å­˜æ•°æ®åº“**: Redis 7+ (é«˜é€Ÿç¼“å­˜ï¼Œä¼šè¯å­˜å‚¨)  
- **æ—¶åºæ•°æ®åº“**: InfluxDB 2.0+ (ç›‘æ§æŒ‡æ ‡ï¼Œæ€§èƒ½æ•°æ®)
- **æœç´¢å¼•æ“**: Elasticsearch 8+ (å…¨æ–‡æœç´¢ï¼Œæ—¥å¿—åˆ†æ)

### æ•°æ®å±‚æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æœåŠ¡å±‚    â”‚    â”‚    ç¼“å­˜å±‚        â”‚    â”‚   æŒä¹…åŒ–å±‚      â”‚
â”‚   (Node.js)     â”‚â”€â”€â”€â–¶â”‚   (Redis)        â”‚â”€â”€â”€â–¶â”‚  (PostgreSQL)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚                        â”‚
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚    ä¼šè¯ç¼“å­˜        â”‚    â”‚   ä¸šåŠ¡æ•°æ®åº“    â”‚
         â”‚              â”‚  æœç´¢ç»“æœç¼“å­˜      â”‚    â”‚   ç”¨æˆ·æ•°æ®      â”‚
         â”‚              â”‚  çƒ­ç‚¹æ•°æ®ç¼“å­˜      â”‚    â”‚   ç»Ÿè®¡æ•°æ®      â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç›‘æ§æŒ‡æ ‡      â”‚    â”‚    æ—¥å¿—åˆ†æ      â”‚
â”‚  (InfluxDB)     â”‚    â”‚ (Elasticsearch)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒå®ä½“å…³ç³»å›¾
```
Users (ç”¨æˆ·è¡¨)
â”œâ”€â”€ UserSessions (ç”¨æˆ·ä¼šè¯)
â”œâ”€â”€ SearchHistory (æœç´¢å†å²)
â”œâ”€â”€ Favorites (æ”¶è—å•†å“)
â””â”€â”€ UserPreferences (ç”¨æˆ·åå¥½)

Products (å•†å“è¡¨)
â”œâ”€â”€ ProductPrices (ä»·æ ¼å†å²)
â”œâ”€â”€ ProductImages (å•†å“å›¾ç‰‡)
â””â”€â”€ ProductReviews (å•†å“è¯„ä»·)

SearchRequests (æœç´¢è¯·æ±‚)
â”œâ”€â”€ SearchResults (æœç´¢ç»“æœ)
â””â”€â”€ SearchMetrics (æœç´¢æŒ‡æ ‡)

SystemLogs (ç³»ç»Ÿæ—¥å¿—)
â”œâ”€â”€ ApiLogs (APIæ—¥å¿—)
â”œâ”€â”€ ErrorLogs (é”™è¯¯æ—¥å¿—)
â””â”€â”€ PerformanceLogs (æ€§èƒ½æ—¥å¿—)
```

## ğŸ—ï¸ PostgreSQL è¡¨ç»“æ„è®¾è®¡

### 1. ç”¨æˆ·ç›¸å…³è¡¨

#### ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  uuid UUID DEFAULT gen_random_uuid() UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE,
  email VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255),
  avatar_url VARCHAR(500),
  is_active BOOLEAN DEFAULT true,
  is_premium BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  last_login_at TIMESTAMP WITH TIME ZONE,
  login_count INTEGER DEFAULT 0,
  
  -- ç´¢å¼•
  CONSTRAINT users_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- ç´¢å¼•
CREATE INDEX idx_users_uuid ON users(uuid);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_active ON users(is_active);
CREATE INDEX idx_users_created_at ON users(created_at);
```

#### ç”¨æˆ·ä¼šè¯è¡¨ (user_sessions)
```sql
CREATE TABLE user_sessions (
  id SERIAL PRIMARY KEY,
  session_id VARCHAR(128) UNIQUE NOT NULL,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  ip_address INET,
  user_agent TEXT,
  device_info JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  is_active BOOLEAN DEFAULT true,
  
  -- è¿‡æœŸæ—¶é—´æ£€æŸ¥
  CONSTRAINT session_valid_time CHECK (expires_at > created_at)
);

-- ç´¢å¼•
CREATE INDEX idx_sessions_session_id ON user_sessions(session_id);
CREATE INDEX idx_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_sessions_active ON user_sessions(is_active);
```

#### ç”¨æˆ·åå¥½è¡¨ (user_preferences)
```sql
CREATE TABLE user_preferences (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  preferred_platforms TEXT[] DEFAULT ARRAY['jd', 'taobao', 'pdd', 'ali1688'],
  price_range_min DECIMAL(10,2) DEFAULT 0,
  price_range_max DECIMAL(10,2) DEFAULT 99999,
  sort_preference VARCHAR(20) DEFAULT 'price', -- price, rating, sales, relevance
  notification_enabled BOOLEAN DEFAULT true,
  language VARCHAR(10) DEFAULT 'zh-CN',
  timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(user_id),
  CONSTRAINT valid_sort_preference CHECK (sort_preference IN ('price', 'rating', 'sales', 'relevance'))
);

-- ç´¢å¼•
CREATE INDEX idx_preferences_user_id ON user_preferences(user_id);
```

### 2. æœç´¢ç›¸å…³è¡¨

#### æœç´¢è¯·æ±‚è¡¨ (search_requests)
```sql
CREATE TABLE search_requests (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64) UNIQUE NOT NULL,
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  session_id VARCHAR(128),
  keyword VARCHAR(100) NOT NULL,
  platforms TEXT[] NOT NULL,
  limit_per_platform INTEGER DEFAULT 5,
  timeout_seconds INTEGER DEFAULT 15,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- å‚æ•°éªŒè¯
  CONSTRAINT valid_limit CHECK (limit_per_platform BETWEEN 1 AND 20),
  CONSTRAINT valid_timeout CHECK (timeout_seconds BETWEEN 5 AND 30),
  CONSTRAINT valid_keyword CHECK (LENGTH(keyword) BETWEEN 2 AND 100)
);

-- ç´¢å¼•
CREATE INDEX idx_search_requests_request_id ON search_requests(request_id);
CREATE INDEX idx_search_requests_user_id ON search_requests(user_id);
CREATE INDEX idx_search_requests_keyword ON search_requests(keyword);
CREATE INDEX idx_search_requests_created_at ON search_requests(created_at);
CREATE INDEX idx_search_requests_platforms ON search_requests USING GIN(platforms);
```

#### æœç´¢ç»“æœè¡¨ (search_results)
```sql
CREATE TABLE search_results (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64) REFERENCES search_requests(request_id) ON DELETE CASCADE,
  platform VARCHAR(20) NOT NULL,
  success BOOLEAN NOT NULL,
  error_message TEXT,
  scrape_time_ms INTEGER,
  products_count INTEGER DEFAULT 0,
  products_data JSONB,
  scraped_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- å¹³å°éªŒè¯
  CONSTRAINT valid_platform CHECK (platform IN ('jd', 'taobao', 'pdd', 'ali1688'))
);

-- ç´¢å¼•
CREATE INDEX idx_search_results_request_id ON search_results(request_id);
CREATE INDEX idx_search_results_platform ON search_results(platform);
CREATE INDEX idx_search_results_success ON search_results(success);
CREATE INDEX idx_search_results_scraped_at ON search_results(scraped_at);
CREATE INDEX idx_search_results_products_data ON search_results USING GIN(products_data);
```

#### æœç´¢å†å²è¡¨ (search_history)
```sql
CREATE TABLE search_history (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  session_id VARCHAR(128),
  keyword VARCHAR(100) NOT NULL,
  platforms TEXT[],
  total_products INTEGER DEFAULT 0,
  successful_platforms INTEGER DEFAULT 0,
  search_time_ms INTEGER,
  ip_address INET,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_search_history_user_id ON search_history(user_id);
CREATE INDEX idx_search_history_keyword ON search_history(keyword);
CREATE INDEX idx_search_history_created_at ON search_history(created_at);
CREATE INDEX idx_search_history_session_id ON search_history(session_id);
```

### 3. å•†å“ç›¸å…³è¡¨

#### å•†å“è¡¨ (products)
```sql
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  platform VARCHAR(20) NOT NULL,
  platform_id VARCHAR(100) NOT NULL,
  title VARCHAR(500) NOT NULL,
  description TEXT,
  brand VARCHAR(100),
  category VARCHAR(100),
  main_image_url VARCHAR(1000),
  shop_name VARCHAR(200),
  shop_url VARCHAR(1000),
  rating DECIMAL(3,2),
  review_count INTEGER DEFAULT 0,
  sales_count INTEGER DEFAULT 0,
  availability BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- å”¯ä¸€çº¦æŸ
  UNIQUE(platform, platform_id),
  
  -- éªŒè¯çº¦æŸ
  CONSTRAINT valid_platform CHECK (platform IN ('jd', 'taobao', 'pdd', 'ali1688')),
  CONSTRAINT valid_rating CHECK (rating BETWEEN 0 AND 5)
);

-- ç´¢å¼•
CREATE INDEX idx_products_platform ON products(platform);
CREATE INDEX idx_products_platform_id ON products(platform_id);
CREATE INDEX idx_products_title ON products USING GIN(to_tsvector('chinese', title));
CREATE INDEX idx_products_brand ON products(brand);
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_updated_at ON products(updated_at);
```

#### å•†å“ä»·æ ¼å†å²è¡¨ (product_prices)
```sql
CREATE TABLE product_prices (
  id SERIAL PRIMARY KEY,
  product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
  price DECIMAL(12,2) NOT NULL,
  original_price DECIMAL(12,2),
  currency VARCHAR(3) DEFAULT 'CNY',
  promotion_info TEXT,
  url VARCHAR(1000),
  scraped_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- ä»·æ ¼éªŒè¯
  CONSTRAINT positive_price CHECK (price > 0),
  CONSTRAINT valid_original_price CHECK (original_price IS NULL OR original_price >= price)
);

-- ç´¢å¼•
CREATE INDEX idx_product_prices_product_id ON product_prices(product_id);
CREATE INDEX idx_product_prices_price ON product_prices(price);
CREATE INDEX idx_product_prices_scraped_at ON product_prices(scraped_at);
```

#### ç”¨æˆ·æ”¶è—è¡¨ (user_favorites)
```sql
CREATE TABLE user_favorites (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- å”¯ä¸€çº¦æŸï¼šç”¨æˆ·ä¸èƒ½é‡å¤æ”¶è—åŒä¸€å•†å“
  UNIQUE(user_id, product_id)
);

-- ç´¢å¼•
CREATE INDEX idx_favorites_user_id ON user_favorites(user_id);
CREATE INDEX idx_favorites_product_id ON user_favorites(product_id);
CREATE INDEX idx_favorites_created_at ON user_favorites(created_at);
```

### 4. ç³»ç»Ÿç›‘æ§è¡¨

#### APIè®¿é—®æ—¥å¿—è¡¨ (api_logs)
```sql
CREATE TABLE api_logs (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64),
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  method VARCHAR(10) NOT NULL,
  endpoint VARCHAR(200) NOT NULL,
  status_code INTEGER NOT NULL,
  response_time_ms INTEGER,
  request_size INTEGER,
  response_size INTEGER,
  ip_address INET,
  user_agent TEXT,
  referer VARCHAR(1000),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åˆ†åŒºè¡¨(æŒ‰æœˆåˆ†åŒº)
CREATE TABLE api_logs_y2025m06 PARTITION OF api_logs
  FOR VALUES FROM ('2025-06-01') TO ('2025-07-01');

-- ç´¢å¼•
CREATE INDEX idx_api_logs_request_id ON api_logs(request_id);
CREATE INDEX idx_api_logs_endpoint ON api_logs(endpoint);
CREATE INDEX idx_api_logs_status_code ON api_logs(status_code);
CREATE INDEX idx_api_logs_created_at ON api_logs(created_at);
CREATE INDEX idx_api_logs_user_id ON api_logs(user_id);
```

#### é”™è¯¯æ—¥å¿—è¡¨ (error_logs)
```sql
CREATE TABLE error_logs (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64),
  error_type VARCHAR(50) NOT NULL,
  error_code VARCHAR(50),
  error_message TEXT NOT NULL,
  stack_trace TEXT,
  context JSONB,
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  ip_address INET,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_error_logs_error_type ON error_logs(error_type);
CREATE INDEX idx_error_logs_error_code ON error_logs(error_code);
CREATE INDEX idx_error_logs_created_at ON error_logs(created_at);
CREATE INDEX idx_error_logs_request_id ON error_logs(request_id);
```

#### ç³»ç»Ÿç»Ÿè®¡è¡¨ (system_stats)
```sql
CREATE TABLE system_stats (
  id SERIAL PRIMARY KEY,
  date DATE NOT NULL,
  total_requests INTEGER DEFAULT 0,
  successful_requests INTEGER DEFAULT 0,
  failed_requests INTEGER DEFAULT 0,
  unique_users INTEGER DEFAULT 0,
  unique_keywords INTEGER DEFAULT 0,
  avg_response_time_ms INTEGER DEFAULT 0,
  platform_stats JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(date)
);

-- ç´¢å¼•
CREATE INDEX idx_system_stats_date ON system_stats(date);
```

## ğŸš€ Redis ç¼“å­˜è®¾è®¡

### ç¼“å­˜ç­–ç•¥
```redis
# æœç´¢ç»“æœç¼“å­˜ (5-15åˆ†é’Ÿ)
search:{keyword}:{platforms}:{limit} -> JSON
ä¾‹: search:è“ç‰™è€³æœº:jd,taobao:5 -> {æœç´¢ç»“æœJSON}

# å•†å“è¯¦æƒ…ç¼“å­˜ (30åˆ†é’Ÿ)
product:{platform}:{product_id} -> JSON
ä¾‹: product:jd:123456789 -> {å•†å“è¯¦æƒ…JSON}

# çƒ­é—¨æœç´¢ç¼“å­˜ (1å°æ—¶)
hot_keywords:daily -> LIST
hot_keywords:weekly -> LIST

# ç”¨æˆ·ä¼šè¯ç¼“å­˜ (24å°æ—¶)
session:{session_id} -> JSON
ä¾‹: session:sess_abc123 -> {ç”¨æˆ·ä¼šè¯æ•°æ®}

# æœç´¢å†å²ç¼“å­˜ (ç”¨æˆ·çº§åˆ«, 1å°æ—¶)
user:{user_id}:search_history -> LIST
ä¾‹: user:12345:search_history -> [æœç´¢å†å²åˆ—è¡¨]

# å¹³å°çŠ¶æ€ç¼“å­˜ (5åˆ†é’Ÿ)
platform_status:{platform} -> JSON
ä¾‹: platform_status:jd -> {å¹³å°çŠ¶æ€ä¿¡æ¯}

# é™æµè®¡æ•°å™¨ (1åˆ†é’Ÿ)
rate_limit:{ip}:{endpoint} -> INTEGER
ä¾‹: rate_limit:192.168.1.1:search -> 15

# ç»Ÿè®¡è®¡æ•°å™¨ (1å¤©)
stats:daily:{date}:{metric} -> INTEGER
ä¾‹: stats:daily:2025-06-13:total_requests -> 12345
```

### ç¼“å­˜é…ç½®
```javascript
// ç¼“å­˜é…ç½®
const cacheConfig = {
  searchResults: {
    ttl: 300,      // 5åˆ†é’Ÿ
    prefix: 'search:'
  },
  productDetails: {
    ttl: 1800,     // 30åˆ†é’Ÿ
    prefix: 'product:'
  },
  userSessions: {
    ttl: 86400,    // 24å°æ—¶
    prefix: 'session:'
  },
  searchHistory: {
    ttl: 3600,     // 1å°æ—¶
    prefix: 'user:'
  },
  platformStatus: {
    ttl: 300,      // 5åˆ†é’Ÿ
    prefix: 'platform_status:'
  },
  rateLimit: {
    ttl: 60,       // 1åˆ†é’Ÿ
    prefix: 'rate_limit:'
  }
};
```

## ğŸ“ˆ InfluxDB ç›‘æ§æ•°æ®è®¾è®¡

### æ€§èƒ½æŒ‡æ ‡
```influxdb
# æœç´¢è¯·æ±‚æŒ‡æ ‡
search_requests,platform=jd,status=success response_time=2100,products_count=5 1687516800000000000
search_requests,platform=taobao,status=failed response_time=5000,error_type="timeout" 1687516800000000000

# ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
system_performance cpu_usage=15.5,memory_usage=25.6,disk_usage=45.2 1687516800000000000

# APIå“åº”æ—¶é—´
api_response_time,endpoint="/api/search",method="GET" value=2800 1687516800000000000

# é”™è¯¯ç»Ÿè®¡
error_count,type="timeout",platform="pdd" count=15 1687516800000000000

# ç”¨æˆ·æ´»è·ƒåº¦
user_activity,type="search" count=156 1687516800000000000
```

## ğŸ” Elasticsearch æ—¥å¿—åˆ†æ

### æ—¥å¿—ç´¢å¼•ç»“æ„
```json
{
  "mappings": {
    "properties": {
      "@timestamp": { "type": "date" },
      "level": { "type": "keyword" },
      "message": { "type": "text", "analyzer": "chinese" },
      "request_id": { "type": "keyword" },
      "user_id": { "type": "integer" },
      "endpoint": { "type": "keyword" },
      "platform": { "type": "keyword" },
      "keyword": { "type": "text", "analyzer": "chinese" },
      "response_time": { "type": "integer" },
      "status_code": { "type": "integer" },
      "ip_address": { "type": "ip" },
      "user_agent": { "type": "text" },
      "error_type": { "type": "keyword" },
      "stack_trace": { "type": "text" }
    }
  }
}
```

## ğŸ—‚ï¸ æ•°æ®åˆ†ç‰‡å’Œåˆ†åŒºç­–ç•¥

### PostgreSQL åˆ†åŒº
```sql
-- APIæ—¥å¿—æŒ‰æœˆåˆ†åŒº
CREATE TABLE api_logs (
  -- å­—æ®µå®šä¹‰...
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE api_logs_y2025m06 PARTITION OF api_logs
  FOR VALUES FROM ('2025-06-01') TO ('2025-07-01');

CREATE TABLE api_logs_y2025m07 PARTITION OF api_logs
  FOR VALUES FROM ('2025-07-01') TO ('2025-08-01');

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
  start_date date;
  end_date date;
  partition_name text;
BEGIN
  start_date := date_trunc('month', CURRENT_DATE + interval '1 month');
  end_date := start_date + interval '1 month';
  partition_name := 'api_logs_y' || to_char(start_date, 'YYYY') || 'm' || to_char(start_date, 'MM');
  
  EXECUTE format('CREATE TABLE %I PARTITION OF api_logs FOR VALUES FROM (%L) TO (%L)',
                 partition_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå®šæ—¶ä»»åŠ¡
SELECT cron.schedule('create-partition', '0 0 25 * *', 'SELECT create_monthly_partition();');
```

### Redis é›†ç¾¤åˆ†ç‰‡
```javascript
// Redisé›†ç¾¤é…ç½®
const redisCluster = {
  nodes: [
    { host: 'redis-node-1', port: 7000 },
    { host: 'redis-node-2', port: 7000 },
    { host: 'redis-node-3', port: 7000 },
    { host: 'redis-node-4', port: 7000 },
    { host: 'redis-node-5', port: 7000 },
    { host: 'redis-node-6', port: 7000 }
  ],
  options: {
    redisOptions: {
      password: process.env.REDIS_PASSWORD
    }
  }
};
```

## ğŸ”§ æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥

### ç´¢å¼•ä¼˜åŒ–
```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_search_requests_user_keyword_time 
ON search_requests(user_id, keyword, created_at DESC);

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_active_users ON users(id) WHERE is_active = true;

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_products_title_search 
ON products USING GIN(to_tsvector('chinese', title));

-- å“ˆå¸Œç´¢å¼•(ç­‰å€¼æŸ¥è¯¢)
CREATE INDEX idx_sessions_hash ON user_sessions USING HASH(session_id);
```

### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä½¿ç”¨EXPLAIN ANALYZEåˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM search_requests 
WHERE user_id = 123 AND created_at > '2025-06-01';

-- é¢„ç¼–è¯‘è¯­å¥
PREPARE search_user_history(INTEGER, TIMESTAMPTZ) AS
SELECT keyword, created_at FROM search_history
WHERE user_id = $1 AND created_at > $2
ORDER BY created_at DESC LIMIT 10;

-- ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW daily_search_stats AS
SELECT 
  date(created_at) as search_date,
  COUNT(*) as total_searches,
  COUNT(DISTINCT user_id) as unique_users,
  AVG(search_time_ms) as avg_search_time
FROM search_requests
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY date(created_at);

-- å®šæ—¶åˆ·æ–°
SELECT cron.schedule('refresh-daily-stats', '0 1 * * *', 
  'REFRESH MATERIALIZED VIEW daily_search_stats;');
```

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨å’Œå¤‡ä»½

### æ•°æ®åŠ å¯†
```sql
-- æ•æ„Ÿå­—æ®µåŠ å¯†
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ç”¨æˆ·å¯†ç åŠ å¯†
UPDATE users SET password_hash = crypt('password', gen_salt('bf', 12));

-- éªŒè¯å¯†ç 
SELECT * FROM users WHERE password_hash = crypt('password', password_hash);

-- æ•°æ®è„±æ•è§†å›¾
CREATE VIEW users_safe AS
SELECT 
  id,
  uuid,
  LEFT(email, 3) || '***' || RIGHT(email, 10) as email_masked,
  is_active,
  created_at
FROM users;
```

### å¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬

# PostgreSQLå¤‡ä»½
pg_dump -h localhost -U postgres -d pricecompare \
  --format=custom --compress=9 \
  --file="/backup/pricecompare_$(date +%Y%m%d_%H%M%S).dump"

# Rediså¤‡ä»½
redis-cli --rdb /backup/redis_$(date +%Y%m%d_%H%M%S).rdb

# æ¸…ç†æ—§å¤‡ä»½(ä¿ç•™7å¤©)
find /backup -name "*.dump" -mtime +7 -delete
find /backup -name "*.rdb" -mtime +7 -delete
```

## ğŸ“Š æ•°æ®æ¸…ç†å’Œå½’æ¡£

### æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†
```sql
-- æ¸…ç†è¿‡æœŸä¼šè¯
DELETE FROM user_sessions WHERE expires_at < CURRENT_TIMESTAMP;

-- å½’æ¡£æ—§æ—¥å¿—æ•°æ®
CREATE TABLE api_logs_archive AS
SELECT * FROM api_logs WHERE created_at < CURRENT_DATE - INTERVAL '90 days';

DELETE FROM api_logs WHERE created_at < CURRENT_DATE - INTERVAL '90 days';

-- å®šæ—¶æ¸…ç†ä»»åŠ¡
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS void AS $$
BEGIN
  -- åˆ é™¤è¿‡æœŸä¼šè¯
  DELETE FROM user_sessions WHERE expires_at < CURRENT_TIMESTAMP;
  
  -- åˆ é™¤90å¤©å‰çš„APIæ—¥å¿—
  DELETE FROM api_logs WHERE created_at < CURRENT_DATE - INTERVAL '90 days';
  
  -- åˆ é™¤30å¤©å‰çš„é”™è¯¯æ—¥å¿—
  DELETE FROM error_logs WHERE created_at < CURRENT_DATE - INTERVAL '30 days';
  
  -- æ¸…ç†Redisè¿‡æœŸé”®
  -- è¿™éœ€è¦åœ¨åº”ç”¨å±‚å¤„ç†
END;
$$ LANGUAGE plpgsql;

-- æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
SELECT cron.schedule('cleanup-old-data', '0 2 * * *', 'SELECT cleanup_old_data();');
```

## ğŸ” æ•°æ®ç›‘æ§å’Œå‘Šè­¦

### ç›‘æ§æŒ‡æ ‡
```sql
-- æ•°æ®åº“è¿æ¥æ•°ç›‘æ§
SELECT count(*) as active_connections 
FROM pg_stat_activity 
WHERE state = 'active';

-- æ…¢æŸ¥è¯¢ç›‘æ§
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
WHERE mean_time > 1000  -- è¶…è¿‡1ç§’çš„æŸ¥è¯¢
ORDER BY mean_time DESC;

-- è¡¨å¤§å°ç›‘æ§
SELECT schemaname, tablename, 
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### å‘Šè­¦è®¾ç½®
```javascript
// æ•°æ®åº“ç›‘æ§å‘Šè­¦
const alertRules = {
  connectionCount: {
    threshold: 80,
    message: 'æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜'
  },
  slowQuery: {
    threshold: 5000, // 5ç§’
    message: 'æ£€æµ‹åˆ°æ…¢æŸ¥è¯¢'
  },
  diskUsage: {
    threshold: 85, // 85%
    message: 'ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜'
  },
  replicationLag: {
    threshold: 10000, // 10ç§’
    message: 'ä¸»ä»å¤åˆ¶å»¶è¿Ÿè¿‡é«˜'
  }
};
```

## ğŸ“ å˜æ›´æ—¥å¿—

### v1.0.0 (2025-06-13)
- åˆå§‹æ•°æ®åº“è®¾è®¡
- ç”¨æˆ·ã€æœç´¢ã€å•†å“ç›¸å…³è¡¨ç»“æ„
- Redisç¼“å­˜ç­–ç•¥è®¾è®¡
- åŸºç¡€ç›‘æ§å’Œæ—¥å¿—è¡¨

### è®¡åˆ’ä¸­çš„æ”¹è¿›
- v1.1.0: å•†å“æ¨èç®—æ³•æ•°æ®è¡¨
- v1.2.0: ç”¨æˆ·è¡Œä¸ºåˆ†æè¡¨
- v1.3.0: ä»·æ ¼é¢„æµ‹æ¨¡å‹æ•°æ®
- v2.0.0: åˆ†å¸ƒå¼æ¶æ„æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´6æœˆ13æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: æ•°æ®åº“æ¶æ„ç»„
