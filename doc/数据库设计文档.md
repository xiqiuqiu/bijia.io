# üóÑÔ∏è ÂïÜÂìÅÊØî‰ª∑Êèí‰ª∂ - Êï∞ÊçÆÂ∫ìËÆæËÆ°ÊñáÊ°£

## üìå ËÆæËÆ°Ê¶ÇËø∞

Êú¨ÊñáÊ°£ÊèèËø∞ÂïÜÂìÅÊØî‰ª∑Êèí‰ª∂ÁöÑÊï∞ÊçÆÂ∫ìËÆæËÆ°ÊñπÊ°àÔºåÂåÖÊã¨Êï∞ÊçÆÊ®°Âûã„ÄÅË°®ÁªìÊûÑ„ÄÅÁ¥¢ÂºïËÆæËÆ°„ÄÅÊï∞ÊçÆÊµÅÁ≠âËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ

> **üí° MVPÊèêÁ§∫**: Â¶ÇÊûúÊÇ®Ë¶ÅÂø´ÈÄüÂÆûÁé∞MVPÁâàÊú¨ÔºåÂèØ‰ª•Ë∑≥ËøáÂ§çÊùÇÁöÑÊï∞ÊçÆÂ∫ìËÆæËÆ°Ôºå‰ΩøÁî®ÁÆÄÂåñÁöÑÊñá‰ª∂Â≠òÂÇ®ÊñπÊ°à„ÄÇËØ¶ËßÅ [MVPÁÆÄÂåñÊû∂ÊûÑÊñπÊ°à.md](./MVPÁÆÄÂåñÊû∂ÊûÑÊñπÊ°à.md)

## üéØ ËÆæËÆ°ÁõÆÊ†á

- ÊîØÊåÅÈ´òÂπ∂ÂèëÊêúÁ¥¢ËØ∑Ê±Ç
- Â≠òÂÇ®Áî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ
- ÁºìÂ≠òÁÉ≠Èó®ÊêúÁ¥¢ÁªìÊûú
- ÁªüËÆ°ÂàÜÊûê‰∏öÂä°Êï∞ÊçÆ
- ‰øùËØÅÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÂíåÂÆåÊï¥ÊÄß

## üöÄ ÁâàÊú¨ÈÄâÊã©ÊåáÂçó

### MVPÁâàÊú¨ (Êé®ËçêÂø´ÈÄüÂêØÂä®)
- ‚úÖ **Êó†ÈúÄÊï∞ÊçÆÂ∫ì**: ‰ΩøÁî®Êñá‰ª∂Â≠òÂÇ® + ÂÜÖÂ≠òÁºìÂ≠ò
- ‚úÖ **Èõ∂ÈÖçÁΩÆ**: Êó†ÈúÄÂÆâË£ÖÊï∞ÊçÆÂ∫ìÊúçÂä°
- ‚úÖ **Âø´ÈÄüÂºÄÂèë**: ‰∏ìÊ≥®Ê†∏ÂøÉÂäüËÉΩÂÆûÁé∞
- ‚ö†Ô∏è **ÂäüËÉΩÈôêÂà∂**: Êó†Áî®Êà∑Á≥ªÁªü„ÄÅÊó†Â§çÊùÇÁªüËÆ°

### Áîü‰∫ßÁâàÊú¨ (ÂÆåÊï¥ÂäüËÉΩ)
- üî• **ÂÆåÊï¥ÂäüËÉΩ**: Áî®Êà∑Á≥ªÁªü„ÄÅÊï∞ÊçÆÂàÜÊûê„ÄÅÁõëÊéßÂëäË≠¶
- üî• **È´òÊÄßËÉΩ**: Êï∞ÊçÆÂ∫ì‰ºòÂåñ„ÄÅÁºìÂ≠òÁ≠ñÁï•
- üî• **ÂèØÊâ©Â±ï**: ÊîØÊåÅÂ§ßËßÑÊ®°ÈÉ®ÁΩ≤
- ‚ö†Ô∏è **Â§çÊùÇÂ∫¶È´ò**: ÈúÄË¶ÅËøêÁª¥ÂíåÊï∞ÊçÆÂ∫ìÁÆ°ÁêÜÁªèÈ™å

## üèóÔ∏è ÊäÄÊúØÊû∂ÊûÑ

### Êï∞ÊçÆÂ∫ìÈÄâÂûã
- **‰∏ªÊï∞ÊçÆÂ∫ì**: PostgreSQL 15+ (ÂÖ≥Á≥ªÂûãÊï∞ÊçÆÔºå‰∫ãÂä°ÊîØÊåÅ)
- **ÁºìÂ≠òÊï∞ÊçÆÂ∫ì**: Redis 7+ (È´òÈÄüÁºìÂ≠òÔºå‰ºöËØùÂ≠òÂÇ®)  
- **Êó∂Â∫èÊï∞ÊçÆÂ∫ì**: InfluxDB 2.0+ (ÁõëÊéßÊåáÊ†áÔºåÊÄßËÉΩÊï∞ÊçÆ)
- **ÊêúÁ¥¢ÂºïÊìé**: Elasticsearch 8+ (ÂÖ®ÊñáÊêúÁ¥¢ÔºåÊó•ÂøóÂàÜÊûê)

### Êï∞ÊçÆÂ±ÇÊû∂ÊûÑ
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Â∫îÁî®ÊúçÂä°Â±Ç    ‚îÇ    ‚îÇ    ÁºìÂ≠òÂ±Ç        ‚îÇ    ‚îÇ   ÊåÅ‰πÖÂåñÂ±Ç      ‚îÇ
‚îÇ   (Node.js)     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   (Redis)        ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  (PostgreSQL)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                        ‚îÇ                        ‚îÇ
         ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ              ‚îÇ    ‰ºöËØùÁºìÂ≠ò        ‚îÇ    ‚îÇ   ‰∏öÂä°Êï∞ÊçÆÂ∫ì    ‚îÇ
         ‚îÇ              ‚îÇ  ÊêúÁ¥¢ÁªìÊûúÁºìÂ≠ò      ‚îÇ    ‚îÇ   Áî®Êà∑Êï∞ÊçÆ      ‚îÇ
         ‚îÇ              ‚îÇ  ÁÉ≠ÁÇπÊï∞ÊçÆÁºìÂ≠ò      ‚îÇ    ‚îÇ   ÁªüËÆ°Êï∞ÊçÆ      ‚îÇ
         ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ÁõëÊéßÊåáÊ†á      ‚îÇ    ‚îÇ    Êó•ÂøóÂàÜÊûê      ‚îÇ
‚îÇ  (InfluxDB)     ‚îÇ    ‚îÇ (Elasticsearch)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìä Êï∞ÊçÆÊ®°ÂûãËÆæËÆ°

### Ê†∏ÂøÉÂÆû‰ΩìÂÖ≥Á≥ªÂõæ
```
Users (Áî®Êà∑Ë°®)
‚îú‚îÄ‚îÄ UserSessions (Áî®Êà∑‰ºöËØù)
‚îú‚îÄ‚îÄ SearchHistory (ÊêúÁ¥¢ÂéÜÂè≤)
‚îú‚îÄ‚îÄ Favorites (Êî∂ËóèÂïÜÂìÅ)
‚îî‚îÄ‚îÄ UserPreferences (Áî®Êà∑ÂÅèÂ•Ω)

Products (ÂïÜÂìÅË°®)
‚îú‚îÄ‚îÄ ProductPrices (‰ª∑Ê†ºÂéÜÂè≤)
‚îú‚îÄ‚îÄ ProductImages (ÂïÜÂìÅÂõæÁâá)
‚îî‚îÄ‚îÄ ProductReviews (ÂïÜÂìÅËØÑ‰ª∑)

SearchRequests (ÊêúÁ¥¢ËØ∑Ê±Ç)
‚îú‚îÄ‚îÄ SearchResults (ÊêúÁ¥¢ÁªìÊûú)
‚îî‚îÄ‚îÄ SearchMetrics (ÊêúÁ¥¢ÊåáÊ†á)

SystemLogs (Á≥ªÁªüÊó•Âøó)
‚îú‚îÄ‚îÄ ApiLogs (APIÊó•Âøó)
‚îú‚îÄ‚îÄ ErrorLogs (ÈîôËØØÊó•Âøó)
‚îî‚îÄ‚îÄ PerformanceLogs (ÊÄßËÉΩÊó•Âøó)
```

## üèóÔ∏è PostgreSQL Ë°®ÁªìÊûÑËÆæËÆ°

### 1. Áî®Êà∑Áõ∏ÂÖ≥Ë°®

#### Áî®Êà∑Ë°® (users)
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  uuid UUID DEFAULT gen_random_uuid() UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE,
  email VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255),
  avatar_url VARCHAR(500),
  is_active BOOLEAN DEFAULT true,
  is_premium BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  last_login_at TIMESTAMP WITH TIME ZONE,
  login_count INTEGER DEFAULT 0,
  
  -- Á¥¢Âºï
  CONSTRAINT users_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- Á¥¢Âºï
CREATE INDEX idx_users_uuid ON users(uuid);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_active ON users(is_active);
CREATE INDEX idx_users_created_at ON users(created_at);
```

#### Áî®Êà∑‰ºöËØùË°® (user_sessions)
```sql
CREATE TABLE user_sessions (
  id SERIAL PRIMARY KEY,
  session_id VARCHAR(128) UNIQUE NOT NULL,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  ip_address INET,
  user_agent TEXT,
  device_info JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  is_active BOOLEAN DEFAULT true,
  
  -- ËøáÊúüÊó∂Èó¥Ê£ÄÊü•
  CONSTRAINT session_valid_time CHECK (expires_at > created_at)
);

-- Á¥¢Âºï
CREATE INDEX idx_sessions_session_id ON user_sessions(session_id);
CREATE INDEX idx_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_sessions_active ON user_sessions(is_active);
```

#### Áî®Êà∑ÂÅèÂ•ΩË°® (user_preferences)
```sql
CREATE TABLE user_preferences (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  preferred_platforms TEXT[] DEFAULT ARRAY['jd', 'taobao', 'pdd', 'ali1688'],
  price_range_min DECIMAL(10,2) DEFAULT 0,
  price_range_max DECIMAL(10,2) DEFAULT 99999,
  sort_preference VARCHAR(20) DEFAULT 'price', -- price, rating, sales, relevance
  notification_enabled BOOLEAN DEFAULT true,
  language VARCHAR(10) DEFAULT 'zh-CN',
  timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(user_id),
  CONSTRAINT valid_sort_preference CHECK (sort_preference IN ('price', 'rating', 'sales', 'relevance'))
);

-- Á¥¢Âºï
CREATE INDEX idx_preferences_user_id ON user_preferences(user_id);
```

### 2. ÊêúÁ¥¢Áõ∏ÂÖ≥Ë°®

#### ÊêúÁ¥¢ËØ∑Ê±ÇË°® (search_requests)
```sql
CREATE TABLE search_requests (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64) UNIQUE NOT NULL,
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  session_id VARCHAR(128),
  keyword VARCHAR(100) NOT NULL,
  platforms TEXT[] NOT NULL,
  limit_per_platform INTEGER DEFAULT 5,
  timeout_seconds INTEGER DEFAULT 15,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- ÂèÇÊï∞È™åËØÅ
  CONSTRAINT valid_limit CHECK (limit_per_platform BETWEEN 1 AND 20),
  CONSTRAINT valid_timeout CHECK (timeout_seconds BETWEEN 5 AND 30),
  CONSTRAINT valid_keyword CHECK (LENGTH(keyword) BETWEEN 2 AND 100)
);

-- Á¥¢Âºï
CREATE INDEX idx_search_requests_request_id ON search_requests(request_id);
CREATE INDEX idx_search_requests_user_id ON search_requests(user_id);
CREATE INDEX idx_search_requests_keyword ON search_requests(keyword);
CREATE INDEX idx_search_requests_created_at ON search_requests(created_at);
CREATE INDEX idx_search_requests_platforms ON search_requests USING GIN(platforms);
```

#### ÊêúÁ¥¢ÁªìÊûúË°® (search_results)
```sql
CREATE TABLE search_results (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64) REFERENCES search_requests(request_id) ON DELETE CASCADE,
  platform VARCHAR(20) NOT NULL,
  success BOOLEAN NOT NULL,
  error_message TEXT,
  scrape_time_ms INTEGER,
  products_count INTEGER DEFAULT 0,
  products_data JSONB,
  scraped_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- Âπ≥Âè∞È™åËØÅ
  CONSTRAINT valid_platform CHECK (platform IN ('jd', 'taobao', 'pdd', 'ali1688'))
);

-- Á¥¢Âºï
CREATE INDEX idx_search_results_request_id ON search_results(request_id);
CREATE INDEX idx_search_results_platform ON search_results(platform);
CREATE INDEX idx_search_results_success ON search_results(success);
CREATE INDEX idx_search_results_scraped_at ON search_results(scraped_at);
CREATE INDEX idx_search_results_products_data ON search_results USING GIN(products_data);
```

#### ÊêúÁ¥¢ÂéÜÂè≤Ë°® (search_history)
```sql
CREATE TABLE search_history (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  session_id VARCHAR(128),
  keyword VARCHAR(100) NOT NULL,
  platforms TEXT[],
  total_products INTEGER DEFAULT 0,
  successful_platforms INTEGER DEFAULT 0,
  search_time_ms INTEGER,
  ip_address INET,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Á¥¢Âºï
CREATE INDEX idx_search_history_user_id ON search_history(user_id);
CREATE INDEX idx_search_history_keyword ON search_history(keyword);
CREATE INDEX idx_search_history_created_at ON search_history(created_at);
CREATE INDEX idx_search_history_session_id ON search_history(session_id);
```

### 3. ÂïÜÂìÅÁõ∏ÂÖ≥Ë°®

#### ÂïÜÂìÅË°® (products)
```sql
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  platform VARCHAR(20) NOT NULL,
  platform_id VARCHAR(100) NOT NULL,
  title VARCHAR(500) NOT NULL,
  description TEXT,
  brand VARCHAR(100),
  category VARCHAR(100),
  main_image_url VARCHAR(1000),
  shop_name VARCHAR(200),
  shop_url VARCHAR(1000),
  rating DECIMAL(3,2),
  review_count INTEGER DEFAULT 0,
  sales_count INTEGER DEFAULT 0,
  availability BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- ÂîØ‰∏ÄÁ∫¶Êùü
  UNIQUE(platform, platform_id),
  
  -- È™åËØÅÁ∫¶Êùü
  CONSTRAINT valid_platform CHECK (platform IN ('jd', 'taobao', 'pdd', 'ali1688')),
  CONSTRAINT valid_rating CHECK (rating BETWEEN 0 AND 5)
);

-- Á¥¢Âºï
CREATE INDEX idx_products_platform ON products(platform);
CREATE INDEX idx_products_platform_id ON products(platform_id);
CREATE INDEX idx_products_title ON products USING GIN(to_tsvector('chinese', title));
CREATE INDEX idx_products_brand ON products(brand);
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_updated_at ON products(updated_at);
```

#### ÂïÜÂìÅ‰ª∑Ê†ºÂéÜÂè≤Ë°® (product_prices)
```sql
CREATE TABLE product_prices (
  id SERIAL PRIMARY KEY,
  product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
  price DECIMAL(12,2) NOT NULL,
  original_price DECIMAL(12,2),
  currency VARCHAR(3) DEFAULT 'CNY',
  promotion_info TEXT,
  url VARCHAR(1000),
  scraped_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- ‰ª∑Ê†ºÈ™åËØÅ
  CONSTRAINT positive_price CHECK (price > 0),
  CONSTRAINT valid_original_price CHECK (original_price IS NULL OR original_price >= price)
);

-- Á¥¢Âºï
CREATE INDEX idx_product_prices_product_id ON product_prices(product_id);
CREATE INDEX idx_product_prices_price ON product_prices(price);
CREATE INDEX idx_product_prices_scraped_at ON product_prices(scraped_at);
```

#### Áî®Êà∑Êî∂ËóèË°® (user_favorites)
```sql
CREATE TABLE user_favorites (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- ÂîØ‰∏ÄÁ∫¶ÊùüÔºöÁî®Êà∑‰∏çËÉΩÈáçÂ§çÊî∂ËóèÂêå‰∏ÄÂïÜÂìÅ
  UNIQUE(user_id, product_id)
);

-- Á¥¢Âºï
CREATE INDEX idx_favorites_user_id ON user_favorites(user_id);
CREATE INDEX idx_favorites_product_id ON user_favorites(product_id);
CREATE INDEX idx_favorites_created_at ON user_favorites(created_at);
```

### 4. Á≥ªÁªüÁõëÊéßË°®

#### APIËÆøÈóÆÊó•ÂøóË°® (api_logs)
```sql
CREATE TABLE api_logs (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64),
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  method VARCHAR(10) NOT NULL,
  endpoint VARCHAR(200) NOT NULL,
  status_code INTEGER NOT NULL,
  response_time_ms INTEGER,
  request_size INTEGER,
  response_size INTEGER,
  ip_address INET,
  user_agent TEXT,
  referer VARCHAR(1000),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ÂàÜÂå∫Ë°®(ÊåâÊúàÂàÜÂå∫)
CREATE TABLE api_logs_y2025m06 PARTITION OF api_logs
  FOR VALUES FROM ('2025-06-01') TO ('2025-07-01');

-- Á¥¢Âºï
CREATE INDEX idx_api_logs_request_id ON api_logs(request_id);
CREATE INDEX idx_api_logs_endpoint ON api_logs(endpoint);
CREATE INDEX idx_api_logs_status_code ON api_logs(status_code);
CREATE INDEX idx_api_logs_created_at ON api_logs(created_at);
CREATE INDEX idx_api_logs_user_id ON api_logs(user_id);
```

#### ÈîôËØØÊó•ÂøóË°® (error_logs)
```sql
CREATE TABLE error_logs (
  id SERIAL PRIMARY KEY,
  request_id VARCHAR(64),
  error_type VARCHAR(50) NOT NULL,
  error_code VARCHAR(50),
  error_message TEXT NOT NULL,
  stack_trace TEXT,
  context JSONB,
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  ip_address INET,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Á¥¢Âºï
CREATE INDEX idx_error_logs_error_type ON error_logs(error_type);
CREATE INDEX idx_error_logs_error_code ON error_logs(error_code);
CREATE INDEX idx_error_logs_created_at ON error_logs(created_at);
CREATE INDEX idx_error_logs_request_id ON error_logs(request_id);
```

#### Á≥ªÁªüÁªüËÆ°Ë°® (system_stats)
```sql
CREATE TABLE system_stats (
  id SERIAL PRIMARY KEY,
  date DATE NOT NULL,
  total_requests INTEGER DEFAULT 0,
  successful_requests INTEGER DEFAULT 0,
  failed_requests INTEGER DEFAULT 0,
  unique_users INTEGER DEFAULT 0,
  unique_keywords INTEGER DEFAULT 0,
  avg_response_time_ms INTEGER DEFAULT 0,
  platform_stats JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(date)
);

-- Á¥¢Âºï
CREATE INDEX idx_system_stats_date ON system_stats(date);
```

## üöÄ Redis ÁºìÂ≠òËÆæËÆ°

### ÁºìÂ≠òÁ≠ñÁï•
```redis
# ÊêúÁ¥¢ÁªìÊûúÁºìÂ≠ò (5-15ÂàÜÈíü)
search:{keyword}:{platforms}:{limit} -> JSON
‰æã: search:ËìùÁâôËÄ≥Êú∫:jd,taobao:5 -> {ÊêúÁ¥¢ÁªìÊûúJSON}

# ÂïÜÂìÅËØ¶ÊÉÖÁºìÂ≠ò (30ÂàÜÈíü)
product:{platform}:{product_id} -> JSON
‰æã: product:jd:123456789 -> {ÂïÜÂìÅËØ¶ÊÉÖJSON}

# ÁÉ≠Èó®ÊêúÁ¥¢ÁºìÂ≠ò (1Â∞èÊó∂)
hot_keywords:daily -> LIST
hot_keywords:weekly -> LIST

# Áî®Êà∑‰ºöËØùÁºìÂ≠ò (24Â∞èÊó∂)
session:{session_id} -> JSON
‰æã: session:sess_abc123 -> {Áî®Êà∑‰ºöËØùÊï∞ÊçÆ}

# ÊêúÁ¥¢ÂéÜÂè≤ÁºìÂ≠ò (Áî®Êà∑Á∫ßÂà´, 1Â∞èÊó∂)
user:{user_id}:search_history -> LIST
‰æã: user:12345:search_history -> [ÊêúÁ¥¢ÂéÜÂè≤ÂàóË°®]

# Âπ≥Âè∞Áä∂ÊÄÅÁºìÂ≠ò (5ÂàÜÈíü)
platform_status:{platform} -> JSON
‰æã: platform_status:jd -> {Âπ≥Âè∞Áä∂ÊÄÅ‰ø°ÊÅØ}

# ÈôêÊµÅËÆ°Êï∞Âô® (1ÂàÜÈíü)
rate_limit:{ip}:{endpoint} -> INTEGER
‰æã: rate_limit:192.168.1.1:search -> 15

# ÁªüËÆ°ËÆ°Êï∞Âô® (1Â§©)
stats:daily:{date}:{metric} -> INTEGER
‰æã: stats:daily:2025-06-13:total_requests -> 12345
```

### ÁºìÂ≠òÈÖçÁΩÆ
```javascript
// ÁºìÂ≠òÈÖçÁΩÆ
const cacheConfig = {
  searchResults: {
    ttl: 300,      // 5ÂàÜÈíü
    prefix: 'search:'
  },
  productDetails: {
    ttl: 1800,     // 30ÂàÜÈíü
    prefix: 'product:'
  },
  userSessions: {
    ttl: 86400,    // 24Â∞èÊó∂
    prefix: 'session:'
  },
  searchHistory: {
    ttl: 3600,     // 1Â∞èÊó∂
    prefix: 'user:'
  },
  platformStatus: {
    ttl: 300,      // 5ÂàÜÈíü
    prefix: 'platform_status:'
  },
  rateLimit: {
    ttl: 60,       // 1ÂàÜÈíü
    prefix: 'rate_limit:'
  }
};
```

## üìà InfluxDB ÁõëÊéßÊï∞ÊçÆËÆæËÆ°

### ÊÄßËÉΩÊåáÊ†á
```influxdb
# ÊêúÁ¥¢ËØ∑Ê±ÇÊåáÊ†á
search_requests,platform=jd,status=success response_time=2100,products_count=5 1687516800000000000
search_requests,platform=taobao,status=failed response_time=5000,error_type="timeout" 1687516800000000000

# Á≥ªÁªüÊÄßËÉΩÊåáÊ†á
system_performance cpu_usage=15.5,memory_usage=25.6,disk_usage=45.2 1687516800000000000

# APIÂìçÂ∫îÊó∂Èó¥
api_response_time,endpoint="/api/search",method="GET" value=2800 1687516800000000000

# ÈîôËØØÁªüËÆ°
error_count,type="timeout",platform="pdd" count=15 1687516800000000000

# Áî®Êà∑Ê¥ªË∑ÉÂ∫¶
user_activity,type="search" count=156 1687516800000000000
```

## üîç Elasticsearch Êó•ÂøóÂàÜÊûê

### Êó•ÂøóÁ¥¢ÂºïÁªìÊûÑ
```json
{
  "mappings": {
    "properties": {
      "@timestamp": { "type": "date" },
      "level": { "type": "keyword" },
      "message": { "type": "text", "analyzer": "chinese" },
      "request_id": { "type": "keyword" },
      "user_id": { "type": "integer" },
      "endpoint": { "type": "keyword" },
      "platform": { "type": "keyword" },
      "keyword": { "type": "text", "analyzer": "chinese" },
      "response_time": { "type": "integer" },
      "status_code": { "type": "integer" },
      "ip_address": { "type": "ip" },
      "user_agent": { "type": "text" },
      "error_type": { "type": "keyword" },
      "stack_trace": { "type": "text" }
    }
  }
}
```

## üóÇÔ∏è Êï∞ÊçÆÂàÜÁâáÂíåÂàÜÂå∫Á≠ñÁï•

### PostgreSQL ÂàÜÂå∫
```sql
-- APIÊó•ÂøóÊåâÊúàÂàÜÂå∫
CREATE TABLE api_logs (
  -- Â≠óÊÆµÂÆö‰πâ...
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (created_at);

-- ÂàõÂª∫ÂàÜÂå∫
CREATE TABLE api_logs_y2025m06 PARTITION OF api_logs
  FOR VALUES FROM ('2025-06-01') TO ('2025-07-01');

CREATE TABLE api_logs_y2025m07 PARTITION OF api_logs
  FOR VALUES FROM ('2025-07-01') TO ('2025-08-01');

-- Ëá™Âä®ÂàÜÂå∫ÁÆ°ÁêÜ
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
  start_date date;
  end_date date;
  partition_name text;
BEGIN
  start_date := date_trunc('month', CURRENT_DATE + interval '1 month');
  end_date := start_date + interval '1 month';
  partition_name := 'api_logs_y' || to_char(start_date, 'YYYY') || 'm' || to_char(start_date, 'MM');
  
  EXECUTE format('CREATE TABLE %I PARTITION OF api_logs FOR VALUES FROM (%L) TO (%L)',
                 partition_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;

-- ÂàõÂª∫ÂÆöÊó∂‰ªªÂä°
SELECT cron.schedule('create-partition', '0 0 25 * *', 'SELECT create_monthly_partition();');
```

### Redis ÈõÜÁæ§ÂàÜÁâá
```javascript
// RedisÈõÜÁæ§ÈÖçÁΩÆ
const redisCluster = {
  nodes: [
    { host: 'redis-node-1', port: 7000 },
    { host: 'redis-node-2', port: 7000 },
    { host: 'redis-node-3', port: 7000 },
    { host: 'redis-node-4', port: 7000 },
    { host: 'redis-node-5', port: 7000 },
    { host: 'redis-node-6', port: 7000 }
  ],
  options: {
    redisOptions: {
      password: process.env.REDIS_PASSWORD
    }
  }
};
```

## üîß Êï∞ÊçÆÂ∫ì‰ºòÂåñÁ≠ñÁï•

### Á¥¢Âºï‰ºòÂåñ
```sql
-- Â§çÂêàÁ¥¢Âºï‰ºòÂåñ
CREATE INDEX idx_search_requests_user_keyword_time 
ON search_requests(user_id, keyword, created_at DESC);

-- ÈÉ®ÂàÜÁ¥¢Âºï
CREATE INDEX idx_active_users ON users(id) WHERE is_active = true;

-- Ë°®ËææÂºèÁ¥¢Âºï
CREATE INDEX idx_products_title_search 
ON products USING GIN(to_tsvector('chinese', title));

-- ÂìàÂ∏åÁ¥¢Âºï(Á≠âÂÄºÊü•ËØ¢)
CREATE INDEX idx_sessions_hash ON user_sessions USING HASH(session_id);
```

### Êü•ËØ¢‰ºòÂåñ
```sql
-- ‰ΩøÁî®EXPLAIN ANALYZEÂàÜÊûêÊü•ËØ¢ËÆ°Âàí
EXPLAIN ANALYZE SELECT * FROM search_requests 
WHERE user_id = 123 AND created_at > '2025-06-01';

-- È¢ÑÁºñËØëËØ≠Âè•
PREPARE search_user_history(INTEGER, TIMESTAMPTZ) AS
SELECT keyword, created_at FROM search_history
WHERE user_id = $1 AND created_at > $2
ORDER BY created_at DESC LIMIT 10;

-- Áâ©ÂåñËßÜÂõæ
CREATE MATERIALIZED VIEW daily_search_stats AS
SELECT 
  date(created_at) as search_date,
  COUNT(*) as total_searches,
  COUNT(DISTINCT user_id) as unique_users,
  AVG(search_time_ms) as avg_search_time
FROM search_requests
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY date(created_at);

-- ÂÆöÊó∂Âà∑Êñ∞
SELECT cron.schedule('refresh-daily-stats', '0 1 * * *', 
  'REFRESH MATERIALIZED VIEW daily_search_stats;');
```

## üõ°Ô∏è Êï∞ÊçÆÂÆâÂÖ®ÂíåÂ§á‰ªΩ

### Êï∞ÊçÆÂä†ÂØÜ
```sql
-- ÊïèÊÑüÂ≠óÊÆµÂä†ÂØÜ
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Áî®Êà∑ÂØÜÁ†ÅÂä†ÂØÜ
UPDATE users SET password_hash = crypt('password', gen_salt('bf', 12));

-- È™åËØÅÂØÜÁ†Å
SELECT * FROM users WHERE password_hash = crypt('password', password_hash);

-- Êï∞ÊçÆËÑ±ÊïèËßÜÂõæ
CREATE VIEW users_safe AS
SELECT 
  id,
  uuid,
  LEFT(email, 3) || '***' || RIGHT(email, 10) as email_masked,
  is_active,
  created_at
FROM users;
```

### Â§á‰ªΩÁ≠ñÁï•
```bash
#!/bin/bash
# Êï∞ÊçÆÂ∫ìÂ§á‰ªΩËÑöÊú¨

# PostgreSQLÂ§á‰ªΩ
pg_dump -h localhost -U postgres -d pricecompare \
  --format=custom --compress=9 \
  --file="/backup/pricecompare_$(date +%Y%m%d_%H%M%S).dump"

# RedisÂ§á‰ªΩ
redis-cli --rdb /backup/redis_$(date +%Y%m%d_%H%M%S).rdb

# Ê∏ÖÁêÜÊóßÂ§á‰ªΩ(‰øùÁïô7Â§©)
find /backup -name "*.dump" -mtime +7 -delete
find /backup -name "*.rdb" -mtime +7 -delete
```

## üìä Êï∞ÊçÆÊ∏ÖÁêÜÂíåÂΩíÊ°£

### Êï∞ÊçÆÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜ
```sql
-- Ê∏ÖÁêÜËøáÊúü‰ºöËØù
DELETE FROM user_sessions WHERE expires_at < CURRENT_TIMESTAMP;

-- ÂΩíÊ°£ÊóßÊó•ÂøóÊï∞ÊçÆ
CREATE TABLE api_logs_archive AS
SELECT * FROM api_logs WHERE created_at < CURRENT_DATE - INTERVAL '90 days';

DELETE FROM api_logs WHERE created_at < CURRENT_DATE - INTERVAL '90 days';

-- ÂÆöÊó∂Ê∏ÖÁêÜ‰ªªÂä°
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS void AS $$
BEGIN
  -- Âà†Èô§ËøáÊúü‰ºöËØù
  DELETE FROM user_sessions WHERE expires_at < CURRENT_TIMESTAMP;
  
  -- Âà†Èô§90Â§©ÂâçÁöÑAPIÊó•Âøó
  DELETE FROM api_logs WHERE created_at < CURRENT_DATE - INTERVAL '90 days';
  
  -- Âà†Èô§30Â§©ÂâçÁöÑÈîôËØØÊó•Âøó
  DELETE FROM error_logs WHERE created_at < CURRENT_DATE - INTERVAL '30 days';
  
  -- Ê∏ÖÁêÜRedisËøáÊúüÈîÆ
  -- ËøôÈúÄË¶ÅÂú®Â∫îÁî®Â±ÇÂ§ÑÁêÜ
END;
$$ LANGUAGE plpgsql;

-- ÊØèÂ§©ÂáåÊô®2ÁÇπÊâßË°åÊ∏ÖÁêÜ
SELECT cron.schedule('cleanup-old-data', '0 2 * * *', 'SELECT cleanup_old_data();');
```

## üîç Êï∞ÊçÆÁõëÊéßÂíåÂëäË≠¶

### ÁõëÊéßÊåáÊ†á
```sql
-- Êï∞ÊçÆÂ∫ìËøûÊé•Êï∞ÁõëÊéß
SELECT count(*) as active_connections 
FROM pg_stat_activity 
WHERE state = 'active';

-- ÊÖ¢Êü•ËØ¢ÁõëÊéß
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
WHERE mean_time > 1000  -- Ë∂ÖËøá1ÁßíÁöÑÊü•ËØ¢
ORDER BY mean_time DESC;

-- Ë°®Â§ßÂ∞èÁõëÊéß
SELECT schemaname, tablename, 
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### ÂëäË≠¶ËÆæÁΩÆ
```javascript
// Êï∞ÊçÆÂ∫ìÁõëÊéßÂëäË≠¶
const alertRules = {
  connectionCount: {
    threshold: 80,
    message: 'Êï∞ÊçÆÂ∫ìËøûÊé•Êï∞ËøáÈ´ò'
  },
  slowQuery: {
    threshold: 5000, // 5Áßí
    message: 'Ê£ÄÊµãÂà∞ÊÖ¢Êü•ËØ¢'
  },
  diskUsage: {
    threshold: 85, // 85%
    message: 'Á£ÅÁõò‰ΩøÁî®ÁéáËøáÈ´ò'
  },
  replicationLag: {
    threshold: 10000, // 10Áßí
    message: '‰∏ª‰ªéÂ§çÂà∂Âª∂ËøüËøáÈ´ò'
  }
};
```

## üìù ÂèòÊõ¥Êó•Âøó

### v1.0.0 (2025-06-13)
- ÂàùÂßãÊï∞ÊçÆÂ∫ìËÆæËÆ°
- Áî®Êà∑„ÄÅÊêúÁ¥¢„ÄÅÂïÜÂìÅÁõ∏ÂÖ≥Ë°®ÁªìÊûÑ
- RedisÁºìÂ≠òÁ≠ñÁï•ËÆæËÆ°
- Âü∫Á°ÄÁõëÊéßÂíåÊó•ÂøóË°®

### ËÆ°Âàí‰∏≠ÁöÑÊîπËøõ
- v1.1.0: ÂïÜÂìÅÊé®ËçêÁÆóÊ≥ïÊï∞ÊçÆË°®
- v1.2.0: Áî®Êà∑Ë°å‰∏∫ÂàÜÊûêË°®
- v1.3.0: ‰ª∑Ê†ºÈ¢ÑÊµãÊ®°ÂûãÊï∞ÊçÆ
- v2.0.0: ÂàÜÂ∏ÉÂºèÊû∂ÊûÑÊîØÊåÅ

---

**ÊñáÊ°£ÁâàÊú¨**: v1.0  
**ÊúÄÂêéÊõ¥Êñ∞**: 2025Âπ¥6Êúà13Êó•  
**Áª¥Êä§Âõ¢Èòü**: Êï∞ÊçÆÂ∫ìÊû∂ÊûÑÁªÑ
